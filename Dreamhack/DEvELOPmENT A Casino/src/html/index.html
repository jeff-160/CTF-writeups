<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Casino</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #111;
      color: #eee;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    .container {
      background: #222;
      padding: 24px 32px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.6);
      width: 480px;
      text-align: center;
    }
    h1 {
      margin-top: 0;
      margin-bottom: 4px;
      font-size: 24px;
    }
    .subtitle {
      font-size: 12px;
      color: #aaa;
      margin-bottom: 16px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      margin-bottom: 6px;
    }
    .balance {
      font-size: 14px;
    }
    .slots {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin: 16px 0;
    }
    .slot {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      background: #111;
      border: 2px solid #444;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 28px;
    }
    input[type="number"] {
      width: 100px;
      padding: 4px 6px;
      border-radius: 4px;
      border: 1px solid #555;
      background: #111;
      color: #eee;
      margin-right: 6px;
    }
    button {
      cursor: pointer;
      border: none;
      border-radius: 4px;
      padding: 6px 10px;
      background: #dca100;
      color: #111;
      font-weight: 600;
    }
    button:disabled {
      background: #555;
      cursor: not-allowed;
    }
    .msg {
      margin-top: 6px;
      font-size: 12px;
      min-height: 16px;
      color: #f5c542;
    }
    .strategy {
      margin-top: 16px;
      text-align: left;
      font-size: 12px;
      color: #ccc;
    }
    .strategy textarea {
      width: 100%;
      height: 120px;
      background: #111;
      color: #eee;
      border-radius: 4px;
      border: 1px solid #555;
      font-size: 11px;
      padding: 6px;
      box-sizing: border-box;
      resize: vertical;
      font-family: monospace;
    }
    .log {
      margin-top: 12px;
      font-size: 11px;
      max-height: 150px;
      overflow-y: auto;
      text-align: left;
      border-top: 1px solid #444;
      padding-top: 8px;
      white-space: pre-wrap;
    }
    #flagBox {
      font-size: 12px;
      color: #f5c542;
      min-height: 16px;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Casino</h1>
    <div class="subtitle">
      ì¸ìƒì€ í•œë°© ëŒë ¤ëŒë ¤
    </div>

    <div class="top-bar">
      <div id="meInfo">(ë¡œê·¸ì¸ ì •ë³´ ì—†ìŒ)</div>
      <button id="loginBtn" style="font-size:11px;padding:3px 6px;">ê²ŒìŠ¤íŠ¸ ë¡œê·¸ì¸</button>
    </div>

    <div class="balance">
      ì”ì•¡: <span id="balance">-</span> í¬ë ˆë”§
      <button id="buyFlagBtn" style="margin-left:8px;font-size:11px;padding:3px 6px;">
        í”Œë˜ê·¸ ìƒì 
      </button>
    </div>
    <div id="flagBox"></div>

    <div style="margin-top:10px;">
      <input type="number" id="bet" min="1" value="10">
      <button id="spinBtn">SPIN</button>
    </div>

    <div class="slots">
      <div class="slot" id="s1">?</div>
      <div class="slot" id="s2">?</div>
      <div class="slot" id="s3">?</div>
    </div>

    <div class="msg" id="msg"></div>

    <div class="strategy">
      <div><b>ğŸ“œ ìë™ ë² íŒ… ì „ëµ (JavaScript, role=vipë§Œ ì‹¤í–‰ ê°€ëŠ¥)</b></div>
      <div style="margin-bottom:4px;">
        ì´ ì½”ë“œëŠ” <code>sandbox.spin(bet)</code>, <code>sandbox.balance</code> ë“±ì„ ì´ìš©í•´
        ìƒŒë“œë°•ìŠ¤ ì•ˆì—ì„œë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
      </div>
      <textarea id="strategyCode" placeholder="// ì˜ˆì‹œ:
for (let i = 0; i < 3; i++) {
  console.log('spin', i);
  let r = sandbox.spin(10);
  console.log(r);
}
return sandbox.balance;"></textarea>
      <button id="runStrategyBtn" style="margin-top:6px;width:100%;">ì „ëµ ìƒŒë“œë°•ìŠ¤ì—ì„œ ì‹¤í–‰</button>
    </div>

    <div class="log" id="log"></div>
  </div>

  <script>
    async function refreshBalance() {
      const res = await fetch('/api/balance');
      const data = await res.json();
      document.getElementById('balance').innerText = data.balance;
    }

    async function refreshMe() {
      const res = await fetch('/api/me');
      const data = await res.json();
      const meInfo = document.getElementById('meInfo');
      if (data.user) {
        meInfo.textContent = `uid=${data.user.uid}, role=${data.user.role}`;
      } else {
        meInfo.textContent = '(ë¡œê·¸ì¸ ì •ë³´ ì—†ìŒ)';
      }
    }

    async function loginGuest() {
      const res = await fetch('/api/login/guest', {
        method: 'POST'
      });
      const data = await res.json();
      document.getElementById('meInfo').textContent =
        `uid=${data.user.uid}, role=${data.user.role}`;
      await refreshBalance();
    }

    async function spin() {
      const btn = document.getElementById('spinBtn');
      btn.disabled = true;
      document.getElementById('msg').innerText = '';

      const bet = parseInt(document.getElementById('bet').value || '0', 10);
      const res = await fetch('/api/spin', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ bet })
      });
      const data = await res.json();

      if (data.error) {
        document.getElementById('msg').innerText = data.error;
      } else {
        document.getElementById('s1').innerText = data.reels[0];
        document.getElementById('s2').innerText = data.reels[1];
        document.getElementById('s3').innerText = data.reels[2];
        document.getElementById('msg').innerText = data.message;
      }

      await refreshBalance();
      btn.disabled = false;
    }

    async function runStrategy() {
      const code = document.getElementById('strategyCode').value;
      const res = await fetch('/api/strategy/run', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ code })
      });
      const data = await res.json();
      let out = '';

      if (data.error) {
        out += `[ERROR] ${data.error}\n`;
      }
      if (data.logs && data.logs.length) {
        out += data.logs.join('\n') + '\n';
      }
      if (data.result !== undefined) {
        out += '\n[RESULT]\n' + JSON.stringify(data.result, null, 2);
      }

      document.getElementById('log').textContent = out || '(ì¶œë ¥ì´ ì—†ìŠµë‹ˆë‹¤.)';
      await refreshBalance();
      await refreshMe();
    }

    async function buyFlag() {
      const res = await fetch('/api/shop/flag', {
        method: 'POST'
      });
      const data = await res.json();
      const flagBox = document.getElementById('flagBox');

      if (res.ok && data.flag) {
        flagBox.textContent = 'FLAG: ' + data.flag;
      } else {
        flagBox.textContent = data.error || 'í”Œë˜ê·¸ êµ¬ë§¤ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
      }

      await refreshBalance();
    }

    document.getElementById('spinBtn').addEventListener('click', spin);
    document.getElementById('runStrategyBtn').addEventListener('click', runStrategy);
    document.getElementById('buyFlagBtn').addEventListener('click', buyFlag);
    document.getElementById('loginBtn').addEventListener('click', loginGuest);

    (async () => {
      await loginGuest();
      await refreshMe();
      await refreshBalance();
    })();
  </script>
</body>
</html>
